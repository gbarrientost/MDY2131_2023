--caso 1

SELECT  
TO_CHAR(C.numrun,'99G999G999') ||'-'|| C.dvrun AS "RUN CLIENTE",
C.pnombre ||' '|| C.snombre ||' '|| C.appaterno ||' '|| C.apmaterno as "NOMBRE CLIENTE",
TO_CHAR(fecha_nacimiento, 'DD "de" month') AS "DIA DE CUMPLEAÑOS",
SR.DIRECCION,
TTC.NRO_TARJETA,MAX(FECHA_TRANSACCION),TTC.ID_SUCURSAL 
FROM TRANSACCION_TARJETA_CLIENTE TTC
INNER JOIN TARJETA_CLIENTE TC ON TTC.NRO_TARJETA=TC.NRO_TARJETA
INNER JOIN CLIENTE C ON TC.NUMRUN=C.NUMRUN
INNER JOIN SUCURSAL_RETAIL SR ON TTC.ID_SUCURSAL=SR.ID_SUCURSAL
GROUP BY TTC.NRO_TARJETA,TTC.ID_SUCURSAL,C.numrun,C.dvrun,C.pnombre,C.snombre, 
C.appaterno,C.apmaterno,fecha_nacimiento,SR.DIRECCION ;

--Caso2

SELECT TO_CHAR(c.NUMRUN,'09G999G999') ||'-'||c.DVRUN AS "RUN CLIENTE",
c.PNOMBRE ||' '|| c.SNOMBRE ||' '|| c.APPATERNO ||' '|| c.APMATERNO AS "NOMBRE CLIENTE",
TO_CHAR(SUM(TTC.MONTO_TOTAL_TRANSACCION),'L999G999G999') AS "COMPRAS/AVANCES/S.AVANCES",
TO_CHAR(TRUNC((SUM(TTC.MONTO_TOTAL_TRANSACCION)/10000)*250),'999G999G999') AS "TOTAL PUNTOS ACUMULADOS"
from transaccion_tarjeta_cliente TTC
INNER JOIN TARJETA_CLIENTE TC ON TTC.NRO_TARJETA = TC.NRO_TARJETA
RIGHT JOIN CLIENTE C ON TC.NUMRUN = C.NUMRUN
WHERE EXTRACT(YEAR FROM FECHA_TRANSACCION) = &AÑO - 1
GROUP BY TTC.NRO_TARJETA,C.NUMRUN,C.DVRUN,C.PNOMBRE,C.SNOMBRE,C.APPATERNO,C.APMATERNO
ORDER BY "COMPRAS/AVANCES/S.AVANCES", APPATERNO;

--caso4

SELECT TO_CHAR(C.NUMRUN,'09G999G999')||'-'||C.DVRUN AS RUT,
C.PNOMBRE||' '||C.APPATERNO||' '||C.APMATERNO AS NOMBRE_CLIENTE,
TO_CHAR(SUM(NVL(T.MONTO_TOTAL_TRANSACCION,0)),'$999G999G999') AS "COMPRAS/AVANCES...",
 CASE 
  WHEN SUM(NVL(T.MONTO_TOTAL_TRANSACCION,0)) < 100000 THEN 'Sin Categoría'
  WHEN SUM(NVL(T.MONTO_TOTAL_TRANSACCION,0)) BETWEEN 100001 AND 1000000 THEN 'Bronce'
  WHEN SUM(NVL(T.MONTO_TOTAL_TRANSACCION,0)) BETWEEN 1000001 AND 4000000 THEN 'Plata'
  WHEN SUM(NVL(T.MONTO_TOTAL_TRANSACCION,0)) BETWEEN 4000000 AND  8000000 THEN 'Silver'
  WHEN SUM(NVL(T.MONTO_TOTAL_TRANSACCION,0)) BETWEEN 8000001 AND 15000000 THEN 'Gold'
  WHEN SUM(NVL(T.MONTO_TOTAL_TRANSACCION,0)) > 15000001 THEN 'Platino'
 END AS categoria
FROM transaccion_tarjeta_cliente t 
INNER JOIN tarjeta_cliente tc ON t.nro_tarjeta=tc.nro_tarjeta 
RIGHT JOIN cliente c ON c.numrun = tc.numrun
GROUP BY t.nro_tarjeta,C.NUMRUN,C.DVRUN, C.PNOMBRE, C.APPATERNO,C.APMATERNO
ORDER BY C.APPATERNO,3 DESC;


--CASO 5

SELECT
TO_CHAR(SYSDATE,'YYYY') AS "AÑO",
TO_CHAR(C.NUMRUN,'99G999G999')||'-'||C.DVRUN AS "RUT CLIENTE",
INITCAP(C.PNOMBRE)||' '||NVL(SUBSTR(C.SNOMBRE,1,1),'')||'. '||INITCAP(C.APPATERNO)||' '||INITCAP(C.APMATERNO) "NOMBRE CLIENTE",
COUNT(TC.NRO_TARJETA) AS "TOTAL SUPER AVANCES VIGENTES",
TO_CHAR(SUM(TTC.MONTO_TRANSACCION),'L99G999G999') AS "MONTO TOTAL SUPER AVANCES"
FROM TRANSACCION_TARJETA_CLIENTE TTC
INNER JOIN TARJETA_CLIENTE TC ON TTC.NRO_TARJETA=TC.NRO_TARJETA
INNER JOIN CLIENTE C ON TC.NUMRUN=C.NUMRUN
WHERE TTC.COD_TPTRAN_TARJETA=103 AND EXTRACT(YEAR FROM SYSDATE)=EXTRACT(YEAR FROM FECHA_TRANSACCION)
GROUP BY TTC.NRO_TARJETA,C.NUMRUN,C.DVRUN,C.PNOMBRE,C.APPATERNO,C.SNOMBRE,C.APMATERNO
ORDER BY APPATERNO;


--CASO 3 

SELECT TO_CHAR(TTC.FECHA_TRANSACCION, 'MMYYYY') AS "MES TRANSACCIÓN",
TTT.NOMBRE_TPTRAN_TARJETA AS "TIPO TRANSACCIÓN",
TO_CHAR(SUM(TTC.MONTO_TRANSACCION), 'L9G999G999') AS "MONTO COMPRAS/AVANCES/SUPER AVANCES",
--TO_CHAR(SUM(TTC.MONTO_TRANSACCION) * (ASBIF.PORC_APORTE_SBIF / 100), 'L9G999G999') AS "APORTE A LA SBIF"
TO_CHAR(CASE
WHEN SUM(TTC.MONTO_TRANSACCION) BETWEEN 100000 AND 1000000 THEN (SUM(TTC.MONTO_TRANSACCION))*1/100
WHEN SUM(TTC.MONTO_TRANSACCION) BETWEEN 1000001 AND 2000000 THEN (SUM(TTC.MONTO_TRANSACCION))*2/100
WHEN SUM(TTC.MONTO_TRANSACCION) BETWEEN 2000001 AND 4000000 THEN (SUM(TTC.MONTO_TRANSACCION))*3/100
WHEN SUM(TTC.MONTO_TRANSACCION) BETWEEN 4000001 AND 6000000 THEN (SUM(TTC.MONTO_TRANSACCION))*4/100
WHEN SUM(TTC.MONTO_TRANSACCION) BETWEEN 6000001 AND 9999999999 THEN (SUM(TTC.MONTO_TRANSACCION))*7/100
END, 'L9G999G999') AS "APORTE A LA SBIF"
FROM TIPO_TRANSACCION_TARJETA TTT
INNER JOIN TRANSACCION_TARJETA_CLIENTE TTC ON TTT.COD_TPTRAN_TARJETA = TTC.COD_TPTRAN_TARJETA
JOIN APORTE_SBIF ASBIF ON (TTC.MONTO_TRANSACCION BETWEEN ASBIF.MONTO_INF_AV_SAV AND ASBIF.MONTO_SUP_AV_SAV)
WHERE EXTRACT(YEAR FROM TTC.FECHA_TRANSACCION) = EXTRACT(YEAR FROM SYSDATE)
GROUP BY TTT.NOMBRE_TPTRAN_TARJETA, ASBIF.PORC_APORTE_SBIF, TO_CHAR(TTC.FECHA_TRANSACCION, 'MMYYYY')
ORDER BY "MES TRANSACCIÓN" ASC, "TIPO TRANSACCIÓN" ASC;
