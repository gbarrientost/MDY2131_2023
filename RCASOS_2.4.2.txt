Guía 2.4.2



--Caso 1, Informe 1

SELECT TS.DESCRIPCION ||', '|| S.DESCRIPCION "SISTEMA SALUD",

COUNT(A.PAC_RUN) AS "TOTAL ATENCIONES"

FROM TIPO_SALUD TS

INNER JOIN SALUD S ON(TS.TIPO_SAL_ID = S.TIPO_SAL_ID)

INNER JOIN PACIENTE P ON(S.SAL_ID = P.SAL_ID)

INNER JOIN ATENCION A ON(P.PAC_RUN = A.PAC_RUN)

WHERE (TS.TIPO_SAL_ID IN ('F', 'I'))

AND TO_CHAR(FECHA_ATENCION,'MMYYYY') = TO_CHAR(ADD_MONTHS(SYSDATE,-1),'MMYYYY')

GROUP BY TS.DESCRIPCION, S.DESCRIPCION

HAVING COUNT(A.PAC_RUN) > (SELECT

                        ROUND(AVG(COUNT(ATE_ID)))

                        FROM ATENCION

                        WHERE TO_CHAR(FECHA_ATENCION,'MMYYYY') = TO_CHAR(ADD_MONTHS(SYSDATE,-1),'MMYYYY')

                        GROUP BY TO_CHAR(FECHA_ATENCION, 'DD'))

ORDER BY TS.DESCRIPCION ASC, S.DESCRIPCION ASC;



--Caso 1, Informe 2

SELECT TO_CHAR(P.PAC_RUN,'09G999G999') ||'-'|| UPPER(P.DV_RUN) AS "RUT PACIENTE",

P.PNOMBRE ||' '|| P.SNOMBRE ||' '|| P.APATERNO ||' '|| P.AMATERNO "NOMBRE PACIENTE",

ROUND(MONTHS_BETWEEN(SYSDATE, P.FECHA_NACIMIENTO) / 12) AS "AÑOS",

'Le corresponde un ' || PDESCTO.PORCENTAJE_DESCTO ||'% de descuento en la primera consulta médica del año ' || (EXTRACT(YEAR FROM SYSDATE) + 1) AS "PORCENTAJE DESCUENTO"

FROM PACIENTE P

JOIN ATENCION A ON(P.PAC_RUN = A.PAC_RUN)

JOIN PORC_DESCTO_3RA_EDAD PDESCTO ON(ROUND(MONTHS_BETWEEN(SYSDATE, P.FECHA_NACIMIENTO) / 12) BETWEEN PDESCTO.ANNO_INI AND PDESCTO.ANNO_TER)

WHERE A.PAC_RUN IN (SELECT PAC_RUN

                    FROM ATENCION

                    WHERE EXTRACT(YEAR FROM FECHA_ATENCION) = EXTRACT(YEAR FROM SYSDATE)

                    GROUP BY PAC_RUN

                    HAVING COUNT(PAC_RUN) > 4) AND ROUND(MONTHS_BETWEEN(SYSDATE, P.FECHA_NACIMIENTO) / 12) > 65

GROUP BY P.PAC_RUN, P.DV_RUN, P.PNOMBRE, P.SNOMBRE, P.APATERNO, P.AMATERNO, P.FECHA_NACIMIENTO, PDESCTO.PORCENTAJE_DESCTO

ORDER BY P.APATERNO ASC;



--Caso 2

SELECT LOWER(E.NOMBRE) AS "ESPECIALIDAD",

TO_CHAR(M.MED_RUN, '09G999G999') ||'-'|| UPPER(M.DV_RUN) AS "RUT",

UPPER(M.PNOMBRE ||' '|| M.SNOMBRE ||' '|| M.APATERNO ||' '|| M.AMATERNO) AS "MEDICO"

FROM MEDICO M

INNER JOIN ESPECIALIDAD_MEDICO EM ON (M.MED_RUN = EM.MED_RUN)

INNER JOIN ESPECIALIDAD E ON (EM.ESP_ID = E.ESP_ID)

WHERE E.ESP_ID IN (SELECT ESP_ID

                FROM ATENCION

                WHERE EXTRACT(YEAR FROM FECHA_ATENCION) = EXTRACT(YEAR FROM SYSDATE) - 1

                GROUP BY ESP_ID

                HAVING COUNT(ESP_ID) < 10)

ORDER BY E.NOMBRE ASC, M.APATERNO ASC;



--Caso 3

SELECT U.NOMBRE AS "UNIDAD",

M.PNOMBRE ||' '|| M.SNOMBRE ||' '|| M.APATERNO ||' '|| M.AMATERNO AS "MEDICO",

M.TELEFONO AS "TELEFONO",

SUBSTR(U.NOMBRE,1,2) || SUBSTR(M.APATERNO,-3,2) || SUBSTR(M.TELEFONO,-3) ||

TO_CHAR(M.FECHA_CONTRATO,'DDMM') || '@medicocktk.cl' AS "CORREO_MEDICO",

(SELECT COUNT(*) FROM ATENCION WHERE MED_RUN = M.MED_RUN AND EXTRACT(YEAR FROM FECHA_ATENCION) = EXTRACT(YEAR FROM SYSDATE) - 1) AS "ATENCIONES_MEDICAS"

FROM UNIDAD U

INNER JOIN MEDICO M ON(U.UNI_ID = M.UNI_ID)

LEFT JOIN ATENCION A ON(M.MED_RUN = A.MED_RUN)

WHERE (SELECT COUNT(*) FROM ATENCION WHERE MED_RUN = M.MED_RUN AND EXTRACT(YEAR FROM FECHA_ATENCION) = EXTRACT(YEAR FROM SYSDATE) - 1) < (SELECT MAX(COUNT(*))

FROM ATENCION

WHERE EXTRACT(YEAR FROM FECHA_ATENCION) = EXTRACT(YEAR FROM SYSDATE) - 1

GROUP BY MED_RUN)

GROUP BY M.MED_RUN, U.NOMBRE, M.PNOMBRE, M.SNOMBRE, M.APATERNO, M.AMATERNO, M.TELEFONO, M.FECHA_CONTRATO

ORDER BY U.NOMBRE ASC, M.APATERNO ASC;



--Caso 4, Informe 1

SELECT

TO_CHAR(FECHA_ATENCION, 'YYYY/MM') AS "AÑO Y MES",

COUNT(ATE_ID) AS "TOTAL DE ATENCIONES",

TO_CHAR(SUM(COSTO),'L99G999G999') AS "VALOR TOTAL DE LAS ATENCIONES"

FROM ATENCION

WHERE EXTRACT(YEAR FROM FECHA_ATENCION) = EXTRACT(YEAR FROM SYSDATE)

OR EXTRACT(YEAR FROM FECHA_ATENCION) = EXTRACT(YEAR FROM SYSDATE) - 1

OR EXTRACT(YEAR FROM FECHA_ATENCION) = EXTRACT(YEAR FROM SYSDATE) - 2

GROUP BY TO_CHAR(FECHA_ATENCION, 'YYYY/MM')

HAVING COUNT(ATE_ID) >= (SELECT

                        ROUND(AVG(COUNT(ATE_ID)))

                        FROM ATENCION

                        GROUP BY TO_CHAR(FECHA_ATENCION, 'MM/YYYY'))

ORDER BY TO_CHAR(FECHA_ATENCION, 'YYYY/MM');



--Caso 4, Informe 2

SELECT

TO_CHAR(P.PAC_RUN,'09G999G999') ||'-'|| UPPER(P.DV_RUN) AS "RUT PACIENTE",

P.PNOMBRE ||' '|| P.SNOMBRE ||' '|| P.APATERNO ||' '|| P.AMATERNO AS "NOMBRE PACIENTE",

PA.ATE_ID AS "ID ATENCION",

PA.FECHA_VENC_PAGO AS "FECHA VENCIMIENTO PAGO",

PA.FECHA_PAGO AS "FECHA PAGO",

PA.FECHA_PAGO - PA.FECHA_VENC_PAGO AS "DIAS MOROSIDAD",

TO_CHAR((PA.FECHA_PAGO - PA.FECHA_VENC_PAGO) * 2000,'L999G999') AS "VALOR MULTA"

FROM PACIENTE P

JOIN ATENCION A ON(P.PAC_RUN = A.PAC_RUN)

JOIN PAGO_ATENCION PA ON(A.ATE_ID = PA.ATE_ID)

WHERE EXTRACT(YEAR FROM A.FECHA_ATENCION) = EXTRACT(YEAR FROM SYSDATE)

OR EXTRACT(YEAR FROM A.FECHA_ATENCION) = EXTRACT(YEAR FROM SYSDATE) - 1

OR EXTRACT(YEAR FROM A.FECHA_ATENCION) = EXTRACT(YEAR FROM SYSDATE) - 2

GROUP BY P.PAC_RUN, P.DV_RUN, P.PNOMBRE, P.SNOMBRE, P.APATERNO, P.AMATERNO, PA.ATE_ID, PA.FECHA_VENC_PAGO, PA.FECHA_PAGO

HAVING (PA.FECHA_PAGO - PA.FECHA_VENC_PAGO) > (SELECT ROUND(AVG(COUNT(ATE_ID)))

                                    FROM PAGO_ATENCION

                                    WHERE ((FECHA_PAGO - 1) - FECHA_VENC_PAGO) > 0

                                    GROUP BY TO_CHAR(FECHA_PAGO, 'YYYY'))

ORDER BY PA.FECHA_VENC_PAGO ASC, (PA.FECHA_PAGO - PA.FECHA_VENC_PAGO) DESC;



--Caso 5

SELECT TO_CHAR(M.MED_RUN,'09G999G999') ||'-'|| UPPER(M.DV_RUN) AS "RUN MEDICO",

M.PNOMBRE ||' '|| M.SNOMBRE ||' '|| M.APATERNO ||' '|| M.AMATERNO AS "NOMBRE MEDICO",

(SELECT COUNT(*) FROM ATENCION WHERE MED_RUN = M.MED_RUN) AS "TOTAL ATENCIONES MEDICAS",

TO_CHAR(M.SUELDO_BASE,'L9G999G999') AS "SUELDO BASE",

TO_CHAR(ROUND((&&ganancias * 5 / 100) / (SELECT SUM(COUNT(DISTINCT MED_RUN))

                                        FROM ATENCION

                                        WHERE EXTRACT(YEAR FROM FECHA_ATENCION) = EXTRACT(YEAR FROM SYSDATE)

                                        GROUP BY MED_RUN

                                        HAVING COUNT(MED_RUN) > 7)),'L99G999G999') AS "BONIFICACION POR GANANCIAS",

TO_CHAR(M.SUELDO_BASE + ROUND((&ganancias * 5 / 100) / (SELECT SUM(COUNT(DISTINCT MED_RUN))

                                        FROM ATENCION

                                        WHERE EXTRACT(YEAR FROM FECHA_ATENCION) = EXTRACT(YEAR FROM SYSDATE)

                                        GROUP BY MED_RUN

                                        HAVING COUNT(MED_RUN) > 7)),'L9G999G999') AS "SUELDO TOTAL"

FROM MEDICO M

INNER JOIN ATENCION A ON(M.MED_RUN = A.MED_RUN)

WHERE M.MED_RUN IN (SELECT MED_RUN

                    FROM ATENCION

                    WHERE EXTRACT(YEAR FROM FECHA_ATENCION) = EXTRACT(YEAR FROM SYSDATE)

                    GROUP BY MED_RUN

                    HAVING COUNT(MED_RUN) > 7)

GROUP BY M.MED_RUN, M.DV_RUN, M.PNOMBRE, M.SNOMBRE, M.APATERNO, M.AMATERNO, M.SUELDO_BASE

ORDER BY M.MED_RUN ASC, M.APATERNO ASC;