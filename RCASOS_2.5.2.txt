
SELECT TP.DESCRIPCION||','||S.DESCRIPCION AS TIPO_SALUD
FROM SALUD S
INNER JOIN TIPO_SALUD TP ON s.tipo_sal_id=TP.tipo_sal_id;


SELECT ROUND(AVG(COUNT(ATE_ID)))
FROM ATENCION
WHERE TO_CHAR(FECHA_ATENCION,'MMYYYY')= TO_CHAR(ADD_MONTHS(SYSDATE,-1),'MMYYYY')
GROUP BY FECHA_ATENCION;









-- caso 1

SELECT TP.DESCRIPCION||','||S.DESCRIPCION AS SISTEMA_SALUD,
COUNT(A.ATE_ID) AS TOTAL_ATENCIONES,
'CON DESCUENTO' AS "CORRESPONDE DESCUENTO"
FROM ATENCION A
INNER JOIN PACIENTE P ON A.PAC_RUN=P.PAC_RUN
INNER JOIN SALUD S ON P.SAL_ID=S.SAL_ID
INNER JOIN TIPO_SALUD TP ON S.TIPO_SAL_ID=TP.TIPO_SAL_ID
WHERE TO_CHAR(FECHA_ATENCION,'MMYYYY')=TO_CHAR(ADD_MONTHS(SYSDATE,-1),'MMYYYY')
GROUP BY TP.DESCRIPCION,S.DESCRIPCION
HAVING COUNT(A.ATE_ID)>(
SELECT ROUND(AVG(COUNT(A.ATE_ID))) FROM ATENCION A
WHERE TO_CHAR(FECHA_ATENCION,'MMYYYY')=TO_CHAR(ADD_MONTHS(SYSDATE,-1),'MMYYYY')
GROUP BY FECHA_ATENCION)
UNION
SELECT TP.DESCRIPCION||','||S.DESCRIPCION AS SISTEMA_SALUD,
COUNT(A.ATE_ID) AS TOTAL_ATENCIONES,
'SIN DESCUENTO'
FROM ATENCION A
INNER JOIN PACIENTE P ON A.PAC_RUN=P.PAC_RUN
INNER JOIN SALUD S ON P.SAL_ID=S.SAL_ID
INNER JOIN TIPO_SALUD TP ON S.TIPO_SAL_ID=TP.TIPO_SAL_ID
WHERE TO_CHAR(FECHA_ATENCION,'MMYYYY')=TO_CHAR(ADD_MONTHS(SYSDATE,-1),'MMYYYY')
GROUP BY TP.DESCRIPCION,S.DESCRIPCION
HAVING COUNT(A.ATE_ID)<=(
SELECT ROUND(AVG(COUNT(A.ATE_ID))) FROM ATENCION A
WHERE TO_CHAR(FECHA_ATENCION,'MMYYYY')=TO_CHAR(ADD_MONTHS(SYSDATE,-1),'MMYYYY')
GROUP BY FECHA_ATENCION)
UNION
SELECT TP.DESCRIPCION||','||S.DESCRIPCION AS SISTEMA_SALUD,
0,
'SIN DESCUENTO'
FROM SALUD S
INNER JOIN TIPO_SALUD TP ON s.tipo_sal_id=TP.tipo_sal_id
WHERE S.SAL_ID NOT IN(
SELECT S.SAL_ID
FROM ATENCION A
INNER JOIN PACIENTE P ON A.PAC_RUN=P.PAC_RUN
INNER JOIN SALUD S ON P.SAL_ID=S.SAL_ID
INNER JOIN TIPO_SALUD TP ON S.TIPO_SAL_ID=TP.TIPO_SAL_ID
WHERE TO_CHAR(FECHA_ATENCION,'MMYYYY')=TO_CHAR(ADD_MONTHS(SYSDATE,-1),'MMYYYY')
GROUP BY S.SAL_ID);



-- CASO 1 Parte 2


SELECT TO_CHAR(PAC_RUN,'09G999G999')||'-'||DV_RUN AS "RUT PACIENTE",
PNOMBRE||' '||SNOMBRE||' '||APATERNO||' '||AMATERNO AS "NOMBRE PACIENTE",
ROUND(MONTHS_BETWEEN(SYSDATE,FECHA_NACIMIENTO)/12) AS "EDAD",
'Le corresponde un '||(SELECT PORCENTAJE_DESCTO 
FROM PORC_DESCTO_3RA_EDAD
WHERE ROUND(MONTHS_BETWEEN(SYSDATE,FECHA_NACIMIENTO)/12) BETWEEN ANNO_INI AND ANNO_TER)||
'% de descuento en la primera consulta del año 2024' 
AS "PROCENTAJE DESCUENTO",
'Beneficios por tercera edad' AS OBSERVACION
FROM PACIENTE 
WHERE PAC_RUN IN (SELECT A.PAC_RUN 
FROM ATENCION A
INNER JOIN PACIENTE P ON A.PAC_RUN=P.PAC_RUN
WHERE TO_CHAR(A.FECHA_ATENCION,'YYYY')= TO_CHAR(SYSDATE,'YYYY')
AND ROUND(MONTHS_BETWEEN(SYSDATE,P.FECHA_NACIMIENTO)/12)>=65
GROUP BY A.PAC_RUN
HAVING COUNT(A.ATE_ID)>4)
UNION
SELECT TO_CHAR(PAC_RUN,'09G999G999')||'-'||DV_RUN AS "RUT PACIENTE",
PNOMBRE||' '||SNOMBRE||' '||APATERNO||' '||AMATERNO AS "NOMBRE PACIENTE",
ROUND(MONTHS_BETWEEN(SYSDATE,FECHA_NACIMIENTO)/12) AS "EDAD",
'Le corresponde un 2% de descuento en la primera consulta del año 2024' 
AS "PROCENTAJE DESCUENTO",
'Beneficios por cantidad de atenciones médicas anuales' AS OBSERVACION
FROM PACIENTE 
WHERE PAC_RUN IN (SELECT A.PAC_RUN 
FROM ATENCION A
INNER JOIN PACIENTE P ON A.PAC_RUN=P.PAC_RUN
WHERE TO_CHAR(A.FECHA_ATENCION,'YYYY')= TO_CHAR(SYSDATE,'YYYY')
AND ROUND(MONTHS_BETWEEN(SYSDATE,P.FECHA_NACIMIENTO)/12)<65
GROUP BY A.PAC_RUN
HAVING COUNT(A.ATE_ID)>=5);


-- caso 2

SELECT
TO_CHAR(FECHA_ATENCION, 'YYYY/MM') AS "AÑO Y MES",
COUNT(ATE_ID) AS "TOTAL DE ATENCIONES",
TO_CHAR(SUM(COSTO),'L9G999G999') AS "VALOR TOTAL DE LAS ATENCIONES"
FROM ATENCION
WHERE EXTRACT(YEAR FROM FECHA_ATENCION) = '2023'
GROUP BY TO_CHAR(FECHA_ATENCION, 'YYYY/MM')
HAVING COUNT(ATE_ID)>=(
SELECT ROUND(AVG(COUNT(ATE_ID))) FROM ATENCION 
WHERE TO_CHAR(FECHA_ATENCION,'YYYY')=TO_CHAR(ADD_MONTHS(SYSDATE,-1),'YYYY')
GROUP BY TO_CHAR(FECHA_ATENCION, 'MM'))
UNION
SELECT
TO_CHAR(A.FECHA_ATENCION, 'YYYY/MM') AS "AÑO Y MES",
COUNT(A.ATE_ID) AS "TOTAL DE ATENCIONES",
TO_CHAR(SUM(A.COSTO),'L9G999G999') AS "VALOR TOTAL DE LAS ATENCIONES"
FROM ATENCION A
WHERE EXTRACT(YEAR FROM A.FECHA_ATENCION) = '2022'
GROUP BY TO_CHAR(A.FECHA_ATENCION, 'YYYY/MM')
HAVING COUNT(A.ATE_ID)>=15
UNION 
SELECT
TO_CHAR(A.FECHA_ATENCION, 'YYYY/MM') AS "AÑO Y MES",
COUNT(A.ATE_ID) AS "TOTAL DE ATENCIONES",
TO_CHAR(SUM(A.COSTO),'L9G999G999') AS "VALOR TOTAL DE LAS ATENCIONES"
FROM ATENCION A
WHERE EXTRACT(YEAR FROM A.FECHA_ATENCION) = '2021'
GROUP BY TO_CHAR(A.FECHA_ATENCION, 'YYYY/MM')
HAVING COUNT(A.ATE_ID)>=40;
